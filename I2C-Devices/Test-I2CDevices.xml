<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="" name="Create Jar files, one for each device">
    
	<property name="project.name"			value="I2CDevicesTest" />
    
	<property name="build.line"				value="1" />
	<property name="build.version"			value="1" />
    
	<property name="dir.projectRoot"		value="${basedir}" />
	<property name="dir.buildInfo.base"		value="${basedir}/build" />
	
	<property name="dir.jar.basedir"		value="${dir.projectRoot}/target/examples" />
	<property name="dir.distribution"		value="${basedir}/distribution/examples" />
	<property name="dir.distribution.bin"	value="${dir.distribution}/bin" />
	<property name="dir.distribution.lib"	value="${dir.distribution}/lib" />

	<property name="dir.i2cDevices"			value="${basedir}/distribution/devices" />
	<property name="dir.config" 			value="${dir.projectRoot}/cfg"/>
	<property name="dir.scripts" 			value="${dir.projectRoot}/scripts"/>
	

	<property name="pi4j.version" 			value="2.8.0" />
	<property name="log4j2.version" 		value="2.25.3" />
	<property name="slf4j.version" 			value="2.0.17" />

		
	<tstamp>
		<format property="current.time" pattern="yyyy.MM.dd HH:mm:ss" />
	</tstamp>

			
	<!-- ******************************************************************************************************************************* -->
	    
	<target name="ADS_1115" depends="_common" >
		
		<local name="build.number" />
		<buildnumber file="${dir.buildInfo.base}/ADS_1115-Test/build.number"/>
		<mkJar targetName="ADS_1115-Test" buildNumber="${build.number}" binaries="_common/**,ads1115/**" />
    
	</target>
	
	
	<target name="DS_1621" depends="_common" >
		
		<local name="build.number" />
		<buildnumber file="${dir.buildInfo.base}/DS_1621-Test/build.number"/>
		<mkJar targetName="DS_1621-Test" buildNumber="${build.number}" binaries="_common/**,ds1621/**" />
    
	</target>
	
	
	<target name="LM_75" depends="_common" >
		
		<local name="build.number" />
		<buildnumber file="${dir.buildInfo.base}/LM_75-Test/build.number"/>
		<mkJar targetName="LM_75-Test" buildNumber="${build.number}" binaries="_common/**,lm75/**" />
   
	</target>
	
	
	<target name="_common" unless="common.done" description="Dependent on all devices">
				
		<property name="common.done" value="true" />
			
		<copy file="${dir.config}/log4j2.xml" todir="${dir.distribution}"/>
		
		<copy todir="${dir.distribution}" >
			<fileset dir="${dir.scripts}" />
		</copy>

		<delete dir="${dir.distribution.lib}"/>
        <mkdir dir="${dir.distribution.lib}"/>
        
		<copy todir="${dir.distribution.lib}" >
			<fileset dir="${dir.i2cDevices}" />
		</copy>

		<copy file="C:/Users/Stefan/.m2/repository/args4j/args4j/2.37/args4j-2.37.jar" todir="${dir.distribution.lib}"/>
        <copy file="C:/Users/Stefan/.m2/repository/org/apache/logging/log4j/log4j-core/${log4j2.version}/log4j-core-${log4j2.version}.jar" todir="${dir.distribution.lib}"/>
        <copy file="C:/Users/Stefan/.m2/repository/org/apache/logging/log4j/log4j-api/${log4j2.version}/log4j-api-${log4j2.version}.jar" todir="${dir.distribution.lib}"/>
        <copy file="C:/Users/Stefan/.m2/repository/org/apache/logging/log4j/log4j-slf4j2-impl/${log4j2.version}/log4j-slf4j2-impl-${log4j2.version}.jar" todir="${dir.distribution.lib}"/>
        <copy file="C:/Users/Stefan/.m2/repository/org/slf4j/slf4j-api/${slf4j.version}/slf4j-api-${slf4j.version}.jar" todir="${dir.distribution.lib}"/>
        
		<copy file="C:/Users/Stefan/.m2/repository/com/pi4j/pi4j-core/${pi4j.version}/pi4j-core-${pi4j.version}.jar" todir="${dir.distribution.lib}"/>
		
        <copy file="C:/Users/Stefan/.m2/repository/com/pi4j/pi4j-library-linuxfs/${pi4j.version}/pi4j-library-linuxfs-${pi4j.version}.jar" todir="${dir.distribution.lib}"/>
        <copy file="C:/Users/Stefan/.m2/repository/com/pi4j/pi4j-plugin-linuxfs/${pi4j.version}/pi4j-plugin-linuxfs-${pi4j.version}.jar" todir="${dir.distribution.lib}"/>
        
		<copy file="C:/Users/Stefan/.m2/repository/com/pi4j/pi4j-library-gpiod/${pi4j.version}/pi4j-library-gpiod-${pi4j.version}.jar" todir="${dir.distribution.lib}"/>
		<copy file="C:/Users/Stefan/.m2/repository/com/pi4j/pi4j-plugin-gpiod/${pi4j.version}/pi4j-plugin-gpiod-${pi4j.version}.jar" todir="${dir.distribution.lib}"/>
		
	</target>
	
	
	<!-- ****************************************************************************************** -->
	
	<macrodef name="mkJar" >

		<attribute name="targetName" />
		<attribute name="buildNumber" />
		<attribute name="binaries" />
		
		<sequential>

			<echo message="Jar: run = @{targetName}" />

			<echo message="Jar: mkManifest ..." />
			<mkManifest targetName="@{targetName}" builNumber="@{buildNumber}" />
	    
			<local name="jarFileName" />
			<property name="jarFileName" value="${dir.distribution.bin}/@{targetName}-${build.line}.${build.version}.@{buildNumber}.jar" />

			<echo message="Jar: Candidate = ${jarFileName}, Line = ${build.line} Version = ${build.version}, Number = @{buildNumber}, basedir = ${dir.jar.basedir}" />

			<echo message="Jar: delete ${jarFileName}" />
			<delete file="${jarFileName}" failonerror="false"/>

			<echo message="Jar: createte ${jarFileName}" />
			<jar destfile="${jarFileName}"
				basedir="${dir.jar.basedir}"
				includes="@{binaries}/**"
				manifest="${dir.buildInfo.base}/@{targetName}/MANIFEST.MF"
			/>

			<echo message="Jar: done ${jarFileName}" />

		</sequential>
			
	</macrodef>
	
	
	<macrodef name="mkManifest" >
		
		<attribute name="targetName" />
		<attribute name="builNumber" />
		
		<sequential>

			<echo message="Manifest: run = @{targetName}" />
			<echo message="Manifest: Candidate = @{targetName}, Line = ${build.line} Version = ${build.version}, Number = @{builNumber}, Build time = ${current.time}" />
			
			<local name="mfFileName" />
			<property name="mfFileName" value="${dir.buildInfo.base}/@{targetName}/MANIFEST.MF" />
			
			<echo message="Manifest: delete ${mfFileName}" />
			<delete file="${mfFileName}" failonerror="false"/>
	
			<echo message="Manifest: create ${mfFileName}" />
			<manifest file="${mfFileName}">
		        <attribute name="Manifest-Version" 	value="1.0"/>
		        <attribute name="Built-By" 			value="${user.name}"/>
		        <attribute name="Project" 			value="${project.name}"/>
		        <attribute name="Modul" 			value="@{targetName}"/>
		        <attribute name="Build-Line" 		value="${build.line}"/>
		        <attribute name="Build-Version" 	value="${build.version}"/>
		        <attribute name="Build-Number" 		value="@{builNumber}"/>
		        <attribute name="Build-Date" 		value="${current.time}"/>
		    </manifest>
		
			<echo message="Manifest: done ${mfFileName}" />
			
		</sequential>
		
	</macrodef>
	

</project>
